<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Crocodile Mini App</title>

    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #1c1c1e;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        canvas {
            flex: 1;
            background: #ffffff;
            touch-action: none;
            display: block;
        }

        .toolbar {
            height: 64px;
            background: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: space-around;
            border-top: 1px solid #3a3a3c;
        }

        .toolbar input[type="color"] {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            padding: 0;
        }

        .toolbar button {
            background: #ff3b30;
            color: #ffffff;
            border: none;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div class="toolbar">
    <input type="color" id="brushColor" value="#000000" />
    <button id="clearBtn">Очистить</button>
    <button id="finishBtn">Завершить</button>
</div>

<script>
    // ---------------- TELEGRAM INIT ----------------
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    const roomId = tg.initDataUnsafe.start_param;
    if (!roomId) {
        alert("Ошибка: не передан chat_id");
    }

    // ---------------- CANVAS INIT ----------------
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });

    function resizeCanvas() {
        const toolbarHeight = document.querySelector('.toolbar').offsetHeight;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight - toolbarHeight;

        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 6;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ---------------- SOCKET.IO ----------------
    const socket = io({
        transports: ['websocket', 'polling'],
    });

    socket.on('connect', () => {
        console.log('[socket] connected');
        socket.emit('join_room', { room: roomId });
    });

    socket.on('connect_error', (err) => {
        console.error('[socket] error', err);
    });

    socket.on('draw_data', (data) => {
        ctx.strokeStyle = data.color;
        ctx.beginPath();
        ctx.moveTo(data.px, data.py);
        ctx.lineTo(data.x, data.y);
        ctx.stroke();
    });

    // ---------------- DRAWING ----------------
    let drawing = false;
    let lastPos = { x: 0, y: 0 };

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top,
        };
    };

    canvas.addEventListener('pointerdown', (e) => {
        drawing = true;
        lastPos = getPos(e);
    });

    canvas.addEventListener('pointermove', (e) => {
        if (!drawing) return;

        const pos = getPos(e);
        const color = document.getElementById('brushColor').value;

        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(lastPos.x, lastPos.y);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        socket.emit('draw_step', {
            room: roomId,
            px: lastPos.x,
            py: lastPos.y,
            x: pos.x,
            y: pos.y,
            color: color,
        });

        lastPos = pos;
    });

    window.addEventListener('pointerup', () => {
        drawing = false;
    });

    // ---------------- CONTROLS ----------------
    document.getElementById('clearBtn').onclick = () => {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    };

    document.getElementById('finishBtn').onclick = () => {
        if (!confirm('Завершить раунд и отправить рисунок в чат?')) return;

        const image = canvas.toDataURL('image/jpeg', 0.85);
        socket.emit('final_frame', {
            room: roomId,
            image: image,
        });

        tg.close();
    };
</script>

</body>
</html>
